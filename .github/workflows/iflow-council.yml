name: iflow-council-auto-pr

on:
  workflow_dispatch:
    inputs:
      debug_tmate:
        description: "Enable tmate SSH debug session"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
  schedule:
    # 04:00 China Standard Time (UTC+8) == 20:00 UTC (previous day)
    - cron: "0 20 * * *"

concurrency:
  group: iflow-council-auto-pr
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  council:
    runs-on: ubuntu-latest
    env:
      IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install git/gh helpers
        run: |
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list /etc/apt/sources.list.d/microsoft-prod.list || true
          sudo sed -i '/packages.microsoft.com/d' /etc/apt/sources.list.d/*.list || true
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Install iFlow CLI
        run: npm i -g @iflow-ai/iflow-cli@latest

      - name: Patch iFlow CLI retry
        run: sudo env PATH="$PATH" python scripts/ci/iflow_cli_patch.py

      - name: Configure git
        run: |
          git config user.name "iflow-bot"
          git config user.email "iflow-bot@users.noreply.github.com"

      - name: Debug with tmate
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_tmate == 'true' }}
        uses: mxschmitt/action-tmate@v3

      - name: Run iFlow council
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          cd "$GITHUB_WORKSPACE"
          mkdir -p .iflow/evidence
          mkdir -p ~/.iflow
          cat > ~/.iflow/settings.json <<EOF
          {
            "apiKey": "${IFLOW_API_KEY}",
            "baseUrl": "https://apis.iflow.cn/v1",
            "selectedAuthType": "iflow",
            "useExternalAuth": false
          }
          EOF
          unset CI
          set -o pipefail
          PROMPT="你是协调者（非Lead/Chair/提案agent），只负责落盘证据与推进流程；提案/评审/投票agent只输出文本，不写文件。根据 IFLOW.md，从 A 阶段开始行动，并按要求落盘证据。此运行非交互，不得向用户询问是否继续或因 token 高停止；必须在同一轮完成 A–F；并行 Track A/B 必须同时启动，不能先做 A 再询问。单次并行批次中 task 调用数不得超过 5；如需更多，必须拆成多批并分别完成（例如 5+5），不得把两组 task 合并成单批。"
          attempt=0
          while true; do
            attempt=$((attempt+1))
            rm -f /tmp/iflow-client-error-*.json /tmp/iflow-run.log
            echo "iFlow attempt ${attempt}..."
            if iflow -p "$PROMPT" --thinking --yolo --model glm-4.7 2>&1 | tee /tmp/iflow-run.log; then
              echo "iFlow completed successfully."
              break
            fi
            concurrency_hit=0
            if command -v rg >/dev/null 2>&1; then
              if [ -f /tmp/iflow-run.log ] && rg -n "concurrency limit|SubAgent execution failed" /tmp/iflow-run.log >/dev/null 2>&1; then
                concurrency_hit=1
              fi
              if ls /tmp/iflow-client-error-*.json >/dev/null 2>&1 && rg -n "concurrency limit|SubAgent execution failed" /tmp/iflow-client-error-*.json >/dev/null 2>&1; then
                concurrency_hit=1
              fi
            else
              if [ -f /tmp/iflow-run.log ] && grep -Eiq "concurrency limit|SubAgent execution failed" /tmp/iflow-run.log; then
                concurrency_hit=1
              fi
              if ls /tmp/iflow-client-error-*.json >/dev/null 2>&1 && grep -Ei "concurrency limit|SubAgent execution failed" /tmp/iflow-client-error-*.json >/dev/null 2>&1; then
                concurrency_hit=1
              fi
            fi
            if [ "${concurrency_hit}" -eq 1 ]; then
              case "${attempt}" in
                1) sleep_seconds=2 ;;
                2) sleep_seconds=5 ;;
                3) sleep_seconds=10 ;;
                4) sleep_seconds=20 ;;
                5) sleep_seconds=40 ;;
                *) sleep_seconds=60 ;;
              esac
              echo "Detected concurrency-limit error. Backing off ${sleep_seconds}s and retrying..."
              sleep "${sleep_seconds}"
              continue
            fi
            echo "iFlow failed with a non-retryable error. Exiting."
            exit 1
          done
