name: release

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "Create GitHub Release (default: false)"
        type: boolean
        default: false

jobs:
  build-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl build-essential clang lld llvm pkg-config python3 xz-utils file ca-certificates git
      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Install cargo-deb
        run: cargo install cargo-deb --locked
      - name: Build artifacts (x86_64)
        env:
          APPIMAGE_TOOL_URL: https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
        run: |
          ./scripts/ci/build-artifacts.sh x86_64
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-x86_64
          path: dist/*

  build-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build artifacts (aarch64)
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu24.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y curl build-essential clang lld llvm pkg-config python3 xz-utils file ca-certificates git
          run: |
            curl -fsSL https://sh.rustup.rs | sh -s -- -y
            . /root/.cargo/env
            cargo install cargo-deb --locked
            export APPIMAGE_TOOL_URL=https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-aarch64.AppImage
            ./scripts/ci/build-artifacts.sh aarch64
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-aarch64
          path: dist/*

  release:
    runs-on: ubuntu-latest
    needs: [build-x86_64, build-aarch64]
    if: ${{ inputs.publish }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute tag
        id: meta
        run: |
          VERSION=$(python3 -c 'import tomllib; print(tomllib.load(open("Cargo.toml","rb"))["package"]["version"])')
          SHA=$(git rev-parse --short HEAD)
          echo "tag=v${VERSION}+git.${SHA}" >> $GITHUB_OUTPUT
      - uses: actions/download-artifact@v4
        with:
          path: release-assets
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          draft: false
          prerelease: true
          files: |
            release-assets/**/*
