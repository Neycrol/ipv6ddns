name: release

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "Create GitHub Release (default: false)"
        type: boolean
        default: false
      skip_changelog_check:
        description: "Skip CHANGELOG.md verification (for emergency releases)"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  pre-release-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Check CHANGELOG exists
        if: ${{ !inputs.skip_changelog_check }}
        run: |
          if [ ! -f CHANGELOG.md ]; then
            echo "ERROR: CHANGELOG.md not found"
            echo "Please create CHANGELOG.md with release notes"
            exit 1
          fi
      - name: Extract version from Cargo.toml
        id: meta
        run: |
          VERSION=$(python3 -c 'import tomllib; print(tomllib.load(open("Cargo.toml","rb"))["package"]["version"])')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Verify CHANGELOG contains version
        if: ${{ !inputs.skip_changelog_check }}
        run: |
          VERSION="${{ steps.meta.outputs.version }}"
          # 匹配格式: ## [1.0.0] 或 ## [1.0.0] - YYYY-MM-DD
          if ! grep -q "## \[${VERSION}\]" CHANGELOG.md; then
            echo "ERROR: CHANGELOG.md does not contain entry for version ${VERSION}"
            echo "Expected format: ## [${VERSION}] or ## [${VERSION}] - YYYY-MM-DD"
            exit 1
          fi
      - name: Run tests
        run: |
          cargo test --all-features
      - name: Check formatting
        run: |
          cargo fmt -- --check
      - name: Run clippy
        run: |
          cargo clippy --all-targets --all-features -- -D warnings
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Install cargo-audit
        run: cargo install --locked cargo-audit
      - name: Install cargo-deny
        run: cargo install --locked cargo-deny
      - name: Run cargo-audit
        run: cargo audit
      - name: Run cargo-deny check
        run: cargo deny check
  build-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list /etc/apt/sources.list.d/microsoft-prod.list
          sudo sed -i '/packages.microsoft.com/d' /etc/apt/sources.list.d/*.list || true
          sudo apt-get update
          sudo apt-get install -y curl build-essential clang lld llvm pkg-config python3 xz-utils file ca-certificates git dpkg-dev
      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-x86_64-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-x86_64-
            ${{ runner.os }}-cargo-
      - name: Build artifacts (x86_64)
        env:
          APPIMAGE_TOOL_URL: auto
        run: |
          ./scripts/ci/build-artifacts.sh x86_64
      - uses: actions/upload-artifact@v6
        with:
          name: ipv6ddns-x86_64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/ipv6ddns-*

  build-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (cross)
        run: |
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list /etc/apt/sources.list.d/microsoft-prod.list
          sudo sed -i '/packages.microsoft.com/d' /etc/apt/sources.list.d/*.list || true
          sudo apt-get update
          sudo apt-get install -y curl build-essential clang lld llvm pkg-config python3 xz-utils file ca-certificates git dpkg-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu lld
      - name: Install Rust + target
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustup target add aarch64-unknown-linux-gnu
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-aarch64-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-aarch64-
            ${{ runner.os }}-cargo-
      - name: Build artifacts (aarch64, cross)
        env:
          APPIMAGE_TOOL_URL: https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          CARGO_BUILD_TARGET: aarch64-unknown-linux-gnu
        run: |
          ./scripts/ci/build-artifacts.sh aarch64
      - uses: actions/upload-artifact@v6
        with:
          name: ipv6ddns-aarch64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/ipv6ddns-*

  build-archpkg:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    needs: [build-x86_64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v7
        with:
          name: ipv6ddns-x86_64
          path: arch-artifacts
      - name: Setup build user
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git sudo base-devel
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder "$GITHUB_WORKSPACE"
      - name: Build Arch package
        run: |
          BIN=$(ls -1 "$GITHUB_WORKSPACE"/arch-artifacts/ipv6ddns-*-x86_64 2>/dev/null | head -n1)
          if [[ -z "$BIN" ]]; then
            echo "Prebuilt binary not found in arch-artifacts" >&2
            ls -la "$GITHUB_WORKSPACE/arch-artifacts" || true
            exit 1
          fi
          chmod +x "$BIN"
          sudo -u builder -H env GITHUB_WORKSPACE="$GITHUB_WORKSPACE" GITHUB_SHA="$GITHUB_SHA" _commit="$GITHUB_SHA" \
            _prebuilt_bin="$BIN" RUSTFLAGS= CARGO_ENCODED_RUSTFLAGS= CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS= \
            bash -c 'cd "$GITHUB_WORKSPACE/packaging/arch"; makepkg -f --noconfirm --syncdeps'
      - uses: actions/upload-artifact@v6
        with:
          name: ipv6ddns-archpkg
          path: |
            packaging/arch/*.pkg.tar.zst

  build-archlinuxarm:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    needs: [build-aarch64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v7
        with:
          name: ipv6ddns-aarch64
          path: alarm-artifacts
      - name: Setup build user
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git sudo base-devel
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder "$GITHUB_WORKSPACE"
      - name: Build Arch Linux ARM package (aarch64)
        run: |
          BIN=$(ls -1 "$GITHUB_WORKSPACE"/alarm-artifacts/ipv6ddns-*-aarch64 2>/dev/null | head -n1)
          if [[ -z "$BIN" ]]; then
            echo "Prebuilt aarch64 binary not found in alarm-artifacts" >&2
            ls -la "$GITHUB_WORKSPACE/alarm-artifacts" || true
            exit 1
          fi
          chmod +x "$BIN"
          sudo -u builder -H env GITHUB_SHA="$GITHUB_SHA" _commit="$GITHUB_SHA" _prebuilt_bin="$BIN" BUILDDIR="/home/builder/build" \
            CARCH="aarch64" CHOST="aarch64-unknown-linux-gnu" \
            bash -c "cd '$GITHUB_WORKSPACE/packaging/archlinuxarm'; makepkg -f --noconfirm --syncdeps --ignorearch"
      - uses: actions/upload-artifact@v6
        with:
          name: ipv6ddns-archlinuxarm
          path: |
            packaging/archlinuxarm/*.pkg.tar.zst

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: android-actions/setup-android@v3
      - name: Install Android SDK/NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;26.2.11394342"
      - name: Prepare signing (optional)
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
        run: |
          if [[ -n "${ANDROID_KEYSTORE_B64:-}" ]]; then
            echo "$ANDROID_KEYSTORE_B64" | base64 -d > "$GITHUB_WORKSPACE/android/app/keystore.jks"
            echo "ANDROID_KEYSTORE_PATH=$GITHUB_WORKSPACE/android/app/keystore.jks" >> $GITHUB_ENV
          fi
      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-android-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-android-
            ${{ runner.os }}-cargo-
      - name: Build Android assets (rust)
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/26.2.11394342
          ANDROID_NDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}/ndk/26.2.11394342
        run: |
          ./scripts/ci/build-android.sh
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: 8.7
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
      - name: Assemble release APK
        env:
          ANDROID_KEYSTORE_PATH: ${{ env.ANDROID_KEYSTORE_PATH }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          gradle -p android :app:assembleRelease
      - uses: actions/upload-artifact@v6
        with:
          name: ipv6ddns-android-apk
          path: |
            android/app/build/outputs/apk/release/*.apk
            android/app/src/main/assets/*.sha256

  release:
    runs-on: ubuntu-latest
    needs: [pre-release-check, security-scan, build-x86_64, build-aarch64, build-archpkg, build-archlinuxarm, build-android]
    if: ${{ inputs.publish }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute tag
        id: meta
        run: |
          VERSION=$(python3 -c 'import tomllib; print(tomllib.load(open("Cargo.toml","rb"))["package"]["version"])')
          SHA=$(git rev-parse --short HEAD)
          echo "tag=v${VERSION}+git.${SHA}" >> $GITHUB_OUTPUT
      - uses: actions/download-artifact@v7
        with:
          path: release-assets
      - name: Deduplicate release assets
        run: |
          set -euo pipefail
          declare -A seen
          while IFS= read -r -d '' file; do
            base="$(basename "$file")"
            if [[ -n "${seen[$base]:-}" ]]; then
              echo "Removing duplicate asset: $file (kept ${seen[$base]})"
              rm -f "$file"
            else
              seen[$base]="$file"
            fi
          done < <(find release-assets -type f -print0)
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            release-assets/**/*
