name: release

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "Create GitHub Release (default: false)"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y curl build-essential clang lld llvm pkg-config python3 xz-utils file ca-certificates git dpkg-dev
      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Build artifacts (x86_64)
        env:
          APPIMAGE_TOOL_URL: auto
        run: |
          ./scripts/ci/build-artifacts.sh x86_64
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-x86_64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/ipv6ddns-*

  build-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (cross)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl build-essential clang lld llvm pkg-config python3 xz-utils file ca-certificates git dpkg-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu lld
      - name: Install Rust + target
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustup target add aarch64-unknown-linux-gnu
      - name: Build artifacts (aarch64, cross)
        env:
          APPIMAGE_TOOL_URL: https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          CARGO_BUILD_TARGET: aarch64-unknown-linux-gnu
        run: |
          ./scripts/ci/build-artifacts.sh aarch64
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-aarch64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/ipv6ddns-*

  release:
    runs-on: ubuntu-latest
    needs: [build-x86_64, build-aarch64]
    if: ${{ inputs.publish }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute tag
        id: meta
        run: |
          VERSION=$(python3 -c 'import tomllib; print(tomllib.load(open("Cargo.toml","rb"))["package"]["version"])')
          SHA=$(git rev-parse --short HEAD)
          echo "tag=v${VERSION}+git.${SHA}" >> $GITHUB_OUTPUT
      - uses: actions/download-artifact@v4
        with:
          path: release-assets
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          draft: false
          prerelease: true
          files: |
            release-assets/**/*
