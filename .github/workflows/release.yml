name: release

on:
  workflow_dispatch:
    inputs:
      publish:
        description: "Create GitHub Release (default: false)"
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list /etc/apt/sources.list.d/microsoft-prod.list
          sudo sed -i '/packages.microsoft.com/d' /etc/apt/sources.list.d/*.list || true
          sudo apt-get update
          sudo apt-get install -y curl build-essential clang lld llvm pkg-config python3 xz-utils file ca-certificates git dpkg-dev
      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Build artifacts (x86_64)
        env:
          APPIMAGE_TOOL_URL: auto
        run: |
          ./scripts/ci/build-artifacts.sh x86_64
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-x86_64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/ipv6ddns-*

  build-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (cross)
        run: |
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list /etc/apt/sources.list.d/microsoft-prod.list
          sudo sed -i '/packages.microsoft.com/d' /etc/apt/sources.list.d/*.list || true
          sudo apt-get update
          sudo apt-get install -y curl build-essential clang lld llvm pkg-config python3 xz-utils file ca-certificates git dpkg-dev gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu lld
      - name: Install Rust + target
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustup target add aarch64-unknown-linux-gnu
      - name: Build artifacts (aarch64, cross)
        env:
          APPIMAGE_TOOL_URL: https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          CARGO_BUILD_TARGET: aarch64-unknown-linux-gnu
        run: |
          ./scripts/ci/build-artifacts.sh aarch64
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-aarch64
          path: |
            dist/*.deb
            dist/*.AppImage
            dist/ipv6ddns-*

  build-archpkg:
    runs-on: ubuntu-latest
    container: archlinux:base-devel
    needs: [build-x86_64]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: ipv6ddns-x86_64
          path: arch-artifacts
      - name: Setup build user
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm --needed git sudo base-devel
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder "$GITHUB_WORKSPACE"
      - name: Build Arch package
        run: |
          BIN=$(ls -1 "$GITHUB_WORKSPACE"/arch-artifacts/ipv6ddns-*-x86_64 2>/dev/null | head -n1)
          if [[ -z "$BIN" ]]; then
            echo "Prebuilt binary not found in arch-artifacts" >&2
            ls -la "$GITHUB_WORKSPACE/arch-artifacts" || true
            exit 1
          fi
          chmod +x "$BIN"
          sudo -u builder -H env GITHUB_WORKSPACE="$GITHUB_WORKSPACE" GITHUB_SHA="$GITHUB_SHA" _commit="$GITHUB_SHA" \
            _prebuilt_bin="$BIN" RUSTFLAGS= CARGO_ENCODED_RUSTFLAGS= CARGO_TARGET_X86_64_UNKNOWN_LINUX_GNU_RUSTFLAGS= \
            bash -c 'cd "$GITHUB_WORKSPACE/packaging/arch"; makepkg -f --noconfirm --syncdeps'
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-archpkg
          path: |
            packaging/arch/*.pkg.tar.zst

  build-archlinuxarm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Arch Linux ARM package (aarch64)
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: archlinux
          base_image: docker.io/heywoodlh/archlinux:latest
          install: |
            pacman-key --init
            pacman-key --populate archlinux
            pacman -Syu --noconfirm
            pacman -S --noconfirm --needed base-devel git rust sudo
          run: |
            useradd -m builder
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
            chown -R builder:builder /github/workspace
            sudo -u builder -H env GITHUB_SHA="$GITHUB_SHA" _commit="$GITHUB_SHA" \
              bash -c 'cd /github/workspace/packaging/archlinuxarm; makepkg -f --noconfirm --syncdeps'
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-archlinuxarm
          path: |
            packaging/archlinuxarm/*.pkg.tar.zst

  build-android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: android-actions/setup-android@v3
      - name: Install Android SDK/NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;26.2.11394342"
      - name: Prepare signing (optional)
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_B64 }}
        run: |
          if [[ -n "${ANDROID_KEYSTORE_B64:-}" ]]; then
            echo "$ANDROID_KEYSTORE_B64" | base64 -d > "$GITHUB_WORKSPACE/android/app/keystore.jks"
            echo "ANDROID_KEYSTORE_PATH=$GITHUB_WORKSPACE/android/app/keystore.jks" >> $GITHUB_ENV
          fi
      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Build Android assets (rust)
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/26.2.11394342
          ANDROID_NDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}/ndk/26.2.11394342
        run: |
          ./scripts/ci/build-android.sh
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: 8.7
      - name: Assemble release APK
        env:
          ANDROID_KEYSTORE_PATH: ${{ env.ANDROID_KEYSTORE_PATH }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          gradle -p android :app:assembleRelease
      - uses: actions/upload-artifact@v4
        with:
          name: ipv6ddns-android-apk
          path: |
            android/app/build/outputs/apk/release/*.apk

  release:
    runs-on: ubuntu-latest
    needs: [build-x86_64, build-aarch64, build-archpkg, build-archlinuxarm, build-android]
    if: ${{ inputs.publish }}
    steps:
      - uses: actions/checkout@v4
      - name: Compute tag
        id: meta
        run: |
          VERSION=$(python3 -c 'import tomllib; print(tomllib.load(open("Cargo.toml","rb"))["package"]["version"])')
          SHA=$(git rev-parse --short HEAD)
          echo "tag=v${VERSION}+git.${SHA}" >> $GITHUB_OUTPUT
      - uses: actions/download-artifact@v4
        with:
          path: release-assets
      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.meta.outputs.tag }}
          name: ${{ steps.meta.outputs.tag }}
          draft: false
          prerelease: false
          files: |
            release-assets/**/*
