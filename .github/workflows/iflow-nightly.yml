name: iflow-nightly-auto-pr

on:
  workflow_dispatch:
  schedule:
    # 03:00 China Standard Time (UTC+8) == 19:00 UTC (previous day)
    - cron: "0 19 * * *"

concurrency:
  group: iflow-nightly-auto-pr
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        run: |
          curl -fsSL https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          "$HOME/.cargo/bin/rustup" component add clippy rustfmt

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run cargo test
        run: cargo test --all-features --verbose

      - name: Run cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run cargo fmt check
        run: cargo fmt -- --check

  test-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: 8.7

      - name: Run Android unit tests
        run: gradle -p android test --stacktrace

  auto-pr:
    needs: [test-and-lint, test-android]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install git/gh helpers
        run: |
          sudo rm -f /etc/apt/sources.list.d/azure-cli.list /etc/apt/sources.list.d/microsoft-prod.list || true
          sudo sed -i '/packages.microsoft.com/d' /etc/apt/sources.list.d/*.list || true
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Install iFlow CLI
        run: npm i -g @iflow-ai/iflow-cli@latest

      - name: Configure git
        run: |
          git config user.name "iflow-bot"
          git config user.email "iflow-bot@users.noreply.github.com"

      - name: Run iFlow auto PR
        env:
          IFLOW_API_KEY: ${{ secrets.IFLOW_API_KEY }}
          IFLOW_MODEL: "glm-4.7"
          IFLOW_MAX_PRS: "0"
          IFLOW_MAX_TURNS: "100"
          IFLOW_DEBUG: "1"
          IFLOW_PING: "1"
          IFLOW_PLAN_MODE: "1"
          IFLOW_DISABLE_SUDO: "1"
          IFLOW_WRITE_CONTEXT: "1"
          IFLOW_DIRECT_GIT: "1"
          IFLOW_CONTEXT: |
            # iFlow Auto-PR Context

            You are an automated improvement bot for the ipv6ddns repository.
            Be bold, creative, and insightfulâ€”keep changes correct and reviewable.
            You run in GitHub Actions with no sudo and no interactive input.
            Read IFLOW_PLAN.md if it exists, then make concrete edits.
            Group changes by category (docs/tests/ci/android-ui/packaging/bugfix/refactor/perf) into separate PRs.
            You MUST create PRs yourself using git + gh:
              - git checkout -b iflow/<category>-<n>
              - git add <files>; git commit -m "<category>: <short>"
              - git push -u origin iflow/<category>-<n>
              - gh pr create --title "<category>: <short>" --body "<rationale/self-review/tests>"
            Never push to main/master. Only use iflow/ branches.
            Before creating any PR, you MUST run the relevant tests locally and ensure they pass.
            For Rust changes: run `cargo test`.
            For Android changes: run `./gradlew -p android test` if applicable, otherwise state why not.
            If tests fail, stop and do not create PRs.
            If no valuable changes, exit without creating PRs.
            Tools are allowed, but only modify files within the repo.
          PYTHONUNBUFFERED: "1"
          GH_TOKEN: ${{ secrets.GH_PAT }}
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          mkdir -p ~/.iflow
          cat > ~/.iflow/settings.json <<EOF
          {
            "apiKey": "${IFLOW_API_KEY}",
            "baseUrl": "https://apis.iflow.cn/v1"
          }
          EOF
          python -u scripts/ci/iflow_auto_pr.py
