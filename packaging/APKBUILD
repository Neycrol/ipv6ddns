# Contributor: Neycrol <neycrol@users.noreply.github.com>
# Maintainer: Neycrol <neycrol@users.noreply.github.com>
pkgname=ipv6ddns-git
pkgver=0
pkgrel=1
pkgdesc="Event-driven IPv6 DDNS client for Cloudflare"
url="https://github.com/Neycrol/ipv6ddns"
arch="x86_64 aarch64"
license="MIT"
provides="ipv6ddns"
conflicts="ipv6ddns"
depends="ca-certificates"
makedepends="cargo git"
_commit=${_commit:-HEAD}
source="git+https://github.com/Neycrol/ipv6ddns.git#commit=${_commit}"
builddir="$srcdir/ipv6ddns"

pkgver() {
	cd "$builddir"
	# Generate version based on date and commit count
	local date=$(git show -s --format=%cd --date=format=%Y%m%d HEAD)
	local count=$(git rev-list --count HEAD)
	local short=$(git rev-parse --short HEAD)
	echo "${date}.r${count}.g${short}"
}

build() {
	cd "$builddir"
	cargo build --release
}

check() {
	cd "$builddir"
	cargo test --release
}

package() {
	cd "$builddir"

	# Install binary
	install -Dm755 target/release/ipv6ddns "$pkgdir"/usr/bin/ipv6ddns

	# Install systemd service (as reference)
	install -Dm644 etc/ipv6ddns.service "$pkgdir"/usr/share/doc/$pkgname/ipv6ddns.service

	# Install config file
	install -Dm644 etc/config.toml "$pkgdir"/etc/ipv6ddns/config.toml

	# Install documentation
	install -Dm644 README.md "$pkgdir"/usr/share/doc/$pkgname/README.md
	install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE
}

sha512sums="SKIP"
